name: Navigator Android App CI (Local Runner)

on:
    # Manual trigger only - for testing on local runner
    workflow_dispatch:
        inputs:
            clean_build:
                description: 'Force clean build (no cache)'
                required: false
                type: boolean
                default: false

env:
    FLEETBASE_KEY: ${{ secrets.FLEETBASE_KEY }}
    GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
    TRANSISTORSOFT_LICENSE_KEY: ${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}
    # Your local Android SDK path (adjust if different)
    ANDROID_SDK_ROOT: ${{ vars.ANDROID_SDK_ROOT || '/home/runner/Android/Sdk' }}
    CLEAN_BUILD: ${{ inputs.clean_build }}

jobs:
    android_build:
        runs-on: [self-hosted, Linux, X64]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'

            - name: Enable Corepack
              run: corepack enable

            - name: Activate Yarn 3.6.4
              run: corepack prepare yarn@3.6.4 --activate

            # ============================================
            # LOCAL RUNNER: No GitHub cache needed - use local disk
            # node_modules persists between runs on local runner
            # ============================================
            - name: Install dependencies
              run: |
                  yarn install --immutable

            - name: Create .env
              run: |
                  # Extract version from tag (remove 'v' prefix), fallback for manual runs
                  VERSION="${GITHUB_REF_NAME#v}"
                  if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
                    VERSION="1.0.0-local"
                  fi
                  cat > .env <<EOF
                  APP_NAME=EtemadLife
                  APP_IDENTIFIER=delivery.etemadlife.platform.drivers
                  APP_LINK_PREFIX=royalstars-el
                  FLEETBASE_HOST=https://api.platform.etemadlife.delivery
                  FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}
                  GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
                  DEFAULT_COORDINATES=36.5399,52.6783
                  FACEBOOK_APP_ID=dummy
                  FACEBOOK_CLIENT_TOKEN=dummy
                  TRANSISTORSOFT_LICENSE_KEY=dummy
                  STOREFRONT_KEY=dummy
                  ANDROID_VERSION_NAME=${VERSION}
                  EOF
                  echo "Created .env with VERSION=${VERSION}"
                  cat .env

            - name: Generate google-services.json (from secret)
              env:
                  GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
              run: |
                  mkdir -p android/app
                  printf '%s' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json

            - name: Validate google-services.json
              run: |
                  python3 -c "import json,sys; json.load(open('android/app/google-services.json','rb')); print('google-services.json -> valid JSON')"

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'

            # ============================================
            # LOCAL RUNNER: Install required system tools
            # ============================================
            - name: Install system dependencies
              run: |
                  if ! command -v unzip &> /dev/null || ! command -v wget &> /dev/null; then
                    echo "ðŸ“¦ Installing required tools..."
                    sudo apt-get update
                    sudo apt-get install -y unzip wget curl
                  else
                    echo "âœ“ Required tools already installed"
                  fi

            # ============================================
            # LOCAL RUNNER: Setup Android SDK (auto-install if missing)
            # ============================================
            - name: Setup Android SDK
              run: |
                  echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"

                  # Check if SDK exists
                  if [ -d "$ANDROID_SDK_ROOT/platform-tools" ]; then
                    echo "âœ“ Android SDK already installed"
                    ls -la "$ANDROID_SDK_ROOT"
                  else
                    echo "ðŸ“¦ Installing Android SDK..."
                    mkdir -p "$ANDROID_SDK_ROOT"
                    cd "$ANDROID_SDK_ROOT"
                    
                    # Download command line tools if not present
                    if [ ! -f "cmdline-tools/latest/bin/sdkmanager" ]; then
                      echo "Downloading Android command line tools..."
                      wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
                      unzip -q cmdline-tools.zip
                      mkdir -p cmdline-tools/latest
                      mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
                      rm -f cmdline-tools.zip
                    fi
                    
                    # Accept licenses
                    yes | ./cmdline-tools/latest/bin/sdkmanager --licenses > /dev/null 2>&1 || true
                    
                    # Install required SDK components
                    echo "Installing SDK components..."
                    ./cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
                    
                    echo "âœ“ Android SDK installed successfully"
                    ls -la "$ANDROID_SDK_ROOT"
                  fi

            - name: Check/Install Ninja
              run: |
                  if command -v ninja &> /dev/null; then
                    echo "âœ“ Ninja already installed: $(ninja --version)"
                  else
                    sudo apt-get update && sudo apt-get install -y ninja-build
                  fi

            # ============================================
            # LOCAL RUNNER: Use Gradle directly (no action caching needed)
            # Local disk caching is automatic
            # ============================================
            - name: Make Gradlew Executable
              run: cd android && chmod +x ./gradlew

            # ============================================
            # CLEAN BUILD - Only if requested
            # ============================================
            - name: Clean build directories
              if: inputs.clean_build == true
              run: |
                  cd android
                  ./gradlew clean
                  rm -rf app/build/
                  rm -rf .gradle/
                  echo "âœ“ Cleaned all build directories"

            # ============================================
            # Always clean JS bundle to ensure fresh code
            # ============================================
            - name: Clean stale JS bundle
              run: |
                  cd android
                  # Delete caching directories
                  rm -rf app/build/generated/assets/
                  rm -rf app/build/intermediates/assets/
                  rm -rf app/build/intermediates/merged_assets/
                  # Delete checked-in bundles (THE ROOT CAUSE)
                  rm -f app/src/main/assets/index.android.bundle
                  rm -f app/src/main/assets/index.android.bundle.meta
                  echo "âœ“ Cleaned JS bundle directories - will rebuild fresh"

            # ============================================
            # BUNDLE JS - Manually bundle to ensure standalone APK
            # ============================================
            - name: Bundle JS (Manual)
              run: |
                  mkdir -p android/app/src/main/assets
                  npx react-native bundle \
                    --platform android \
                    --dev false \
                    --entry-file index.js \
                    --bundle-output android/app/src/main/assets/index.android.bundle \
                    --assets-dest android/app/src/main/res
                  echo "âœ“ JS bundle created successfully"
                  ls -la android/app/src/main/assets/

            # ============================================
            # BUILD
            # ============================================
            - name: Build Android Debug APK
              run: |
                  cd android
                  ./gradlew assembleDebug --build-cache --console=plain

            - name: Upload Android APK
              uses: actions/upload-artifact@v4
              with:
                  name: android-debug-local-${{ github.run_number }}-apk
                  path: android/app/build/outputs/apk/debug/app-debug.apk
                  retention-days: 7

            # ============================================
            # LOCAL RUNNER: Optional - copy APK to local path
            # ============================================
            - name: Copy APK to local output
              run: |
                  mkdir -p ~/apk-output
                  cp android/app/build/outputs/apk/debug/app-debug.apk ~/apk-output/app-debug-$(date +%Y%m%d-%H%M%S).apk
                  echo "âœ“ APK copied to ~/apk-output/"
                  ls -la ~/apk-output/
