name: Navigator Android App CI

on:
  push:
    tags:
      - 'v*'

env:
  FLEETBASE_KEY: ${{ secrets.FLEETBASE_KEY }}
  GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
  TRANSISTORSOFT_LICENSE_KEY: ${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  # Shared cache keys (no branch/tag in key = shared across all refs)
  NODE_CACHE_KEY: Linux-node-v1-${{ hashFiles('**/yarn.lock') }}
  SDK_CACHE_KEY: android-sdk-v1-35-ndk-27.1.12297006-cmake-3.22.1

jobs:
  android_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate Yarn 3.6.4
        run: corepack prepare yarn@3.6.4 --activate

      # ============================================
      # NODE_MODULES CACHE - Restore only (no save on tags to prevent duplicates)
      # ============================================
      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        id: node-modules-cache
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ env.NODE_CACHE_KEY }}
          restore-keys: |
            Linux-node-v1-
            Linux-node-

      - name: Install dependencies
        run: |
          # Retry up to 3 times for transient network failures
          for i in 1 2 3; do
            yarn install --immutable && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      # Save cache only if it wasn't restored (prevents saving duplicate on every tag)
      - name: Save node_modules cache
        if: steps.node-modules-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ env.NODE_CACHE_KEY }}

      - name: Create .env
        run: |
          cat > .env <<EOF
          APP_NAME=EtemadLife
          APP_IDENTIFIER=delivery.etemadlife.platform.drivers
          APP_LINK_PREFIX=royalstars-el
          FLEETBASE_KEY=flb_live_PcN1McEg2CoosoEipiMW
          GOOGLE_MAPS_API_KEY=dummy
          DEFAULT_COORDINATES=36.5399,52.6783
          FACEBOOK_APP_ID=dummy
          FACEBOOK_CLIENT_TOKEN=dummy
          TRANSISTORSOFT_LICENSE_KEY=dummy
          STOREFRONT_KEY=dummy
          EOF

      - name: Generate google-services.json (from secret)
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          mkdir -p android/app
          printf '%s' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json

      - name: Validate google-services.json
        run: |
          python -c "import json,sys; json.load(open('android/app/google-services.json','rb')); print('google-services.json -> valid JSON')"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ============================================
      # NINJA - Check if pre-installed before installing
      # ============================================
      - name: Check/Install Ninja
        run: |
          if command -v ninja &> /dev/null; then
            echo "✓ Ninja already installed: $(ninja --version)"
          else
            sudo apt-get update && sudo apt-get install -y ninja-build
          fi

      # ============================================
      # ANDROID SDK/NDK/CMAKE CACHE - Restore only
      # ============================================
      - name: Restore Android SDK cache
        uses: actions/cache/restore@v4
        id: android-sdk-cache
        with:
          path: |
            /usr/local/lib/android/sdk/platforms/android-35
            /usr/local/lib/android/sdk/build-tools/35.0.0
            /usr/local/lib/android/sdk/ndk/27.1.12297006
            /usr/local/lib/android/sdk/cmake/3.22.1
          key: ${{ env.SDK_CACHE_KEY }}
          restore-keys: |
            android-sdk-v1-

      - name: Ensure Android SDK/NDK/CMake toolchain
        if: steps.android-sdk-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -e

          # Find a working sdkmanager (latest if present, else first found)
          if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          else
            SDKMGR=$(ls -1d "$ANDROID_SDK_ROOT/cmdline-tools"/*/bin/sdkmanager 2>/dev/null | head -n1 || true)
            if [ -z "$SDKMGR" ]; then
              SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/bin/sdkmanager"
              "$SDKMGR" "cmdline-tools;latest"
              SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
            fi
          fi

          echo "Using sdkmanager at: $SDKMGR"
          yes | "$SDKMGR" --licenses >/dev/null 2>&1 || true

          need() {
            local p="$1"
            if ! "$SDKMGR" --list_installed | grep -q "^  $p$"; then
              echo "Installing $p"
              "$SDKMGR" "$p"
            else
              echo "✓ $p already installed"
            fi
          }

          need "platforms;android-35"
          need "build-tools;35.0.0"
          need "ndk;27.1.12297006"
          need "cmake;3.22.1"

          "$ANDROID_SDK_ROOT/cmake/3.22.1/bin/cmake" --version || true
          test -f "$ANDROID_SDK_ROOT/ndk/27.1.12297006/source.properties" && echo "✅ NDK 27.1.12297006 installed"

      # Save SDK cache only if not restored
      - name: Save Android SDK cache
        if: steps.android-sdk-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            /usr/local/lib/android/sdk/platforms/android-35
            /usr/local/lib/android/sdk/build-tools/35.0.0
            /usr/local/lib/android/sdk/ndk/27.1.12297006
            /usr/local/lib/android/sdk/cmake/3.22.1
          key: ${{ env.SDK_CACHE_KEY }}

      - name: Verify SDK components (cache hit)
        if: steps.android-sdk-cache.outputs.cache-hit == 'true'
        run: |
          echo "✅ Using cached Android SDK components"
          test -d "$ANDROID_SDK_ROOT/platforms/android-35" && echo "  ✓ platforms;android-35"
          test -d "$ANDROID_SDK_ROOT/build-tools/35.0.0" && echo "  ✓ build-tools;35.0.0"
          test -d "$ANDROID_SDK_ROOT/ndk/27.1.12297006" && echo "  ✓ ndk;27.1.12297006"
          test -d "$ANDROID_SDK_ROOT/cmake/3.22.1" && echo "  ✓ cmake;3.22.1"

      # ============================================
      # GRADLE SETUP WITH BUILT-IN CACHING
      # ============================================
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Make Gradlew Executable
        run: cd android && chmod +x ./gradlew

      # ============================================
      # BUILD
      # ============================================
      - name: Build Android Debug APK
        run: |
          cd android
          ./gradlew assembleDebug --build-cache --console=plain --stacktrace

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-${{ github.ref_name }}-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
  
  android_release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'xyz')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate Yarn 3.6.4
        run: corepack prepare yarn@3.6.4 --activate

      - name: Restore node_modules cache
        uses: actions/cache/restore@v4
        id: node-modules-cache-release
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ env.NODE_CACHE_KEY }}
          restore-keys: |
            Linux-node-v1-
            Linux-node-

      - name: Install dependencies
        run: |
          for i in 1 2 3; do
            yarn install --immutable && break || {
              echo "Attempt $i failed, retrying in 10s..."
              sleep 10
            }
          done

      - name: Save node_modules cache
        if: steps.node-modules-cache-release.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ env.NODE_CACHE_KEY }}

      - name: Create .env file (release)
        run: |
          echo "APP_NAME=EtemadLife" > .env
          echo "APP_LINK_PREFIX=${{ secrets.APP_LINK_PREFIX }}" > .env
          echo "FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}" >> .env
          echo "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}" >> .env
          echo "FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}" >> .env
          echo "FACEBOOK_CLIENT_TOKEN=${{ secrets.FACEBOOK_CLIENT_TOKEN }}" >> .env
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> .env
          echo "DEFAULT_COORDINATES=36.5399,52.6783" >> .env
          echo "TRANSISTORSOFT_LICENSE_KEY=dummy" >> .env
          echo "STOREFRONT_KEY=dummy" >> .env

      - name: Generate google-services.json (from secret)
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          mkdir -p android/app
          printf '%s' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json

      - name: Validate google-services.json (release)
        run: |
          python -c "import json,sys; json.load(open('android/app/google-services.json','rb')); print('google-services.json -> valid JSON')"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Restore Android SDK cache
        uses: actions/cache/restore@v4
        id: android-sdk-cache-release
        with:
          path: |
            /usr/local/lib/android/sdk/platforms/android-35
            /usr/local/lib/android/sdk/build-tools/35.0.0
            /usr/local/lib/android/sdk/ndk/27.1.12297006
            /usr/local/lib/android/sdk/cmake/3.22.1
          key: ${{ env.SDK_CACHE_KEY }}
          restore-keys: |
            android-sdk-v1-

      - name: Save Android SDK cache
        if: steps.android-sdk-cache-release.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            /usr/local/lib/android/sdk/platforms/android-35
            /usr/local/lib/android/sdk/build-tools/35.0.0
            /usr/local/lib/android/sdk/ndk/27.1.12297006
            /usr/local/lib/android/sdk/cmake/3.22.1
          key: ${{ env.SDK_CACHE_KEY }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Build Android Release APK
        run: |
          cd android
          ./gradlew assembleRelease --build-cache --console=plain --stacktrace

      - name: Upload Android Release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-release-${{ github.ref_name }}-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 7
