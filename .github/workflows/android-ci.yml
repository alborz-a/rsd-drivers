name: Navigator Android App CI

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            clean_build:
                description: 'Force clean build (no cache)'
                required: false
                type: boolean
                default: false

env:
    FLEETBASE_KEY: ${{ secrets.FLEETBASE_KEY }}
    GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
    TRANSISTORSOFT_LICENSE_KEY: ${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}
    ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
    CLEAN_BUILD: ${{ endsWith(github.ref_name, '-new') }}

jobs:
    android_build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'

            - name: Enable Corepack
              run: corepack enable

            - name: Activate Yarn 1.22.22
              run: corepack prepare yarn@1.22.22 --activate

            # ============================================
            # NODE_MODULES CACHE - Restore only (no save on tags to prevent duplicates)
            # ============================================
            - name: Restore node_modules cache
              if: env.CLEAN_BUILD != 'true'
              uses: actions/cache/restore@v4
              id: node-modules-cache
              with:
                  path: |
                      node_modules
                      .yarn/cache
                  key: Linux-node-v1-${{ hashFiles('**/yarn.lock') }}

            - name: Install dependencies
              run: |
                  # Retry up to 3 times for transient network failures
                  for i in 1 2 3; do
                    yarn install --immutable && break || {
                      echo "Attempt $i failed, retrying in 10s..."
                      sleep 10
                    }
                  done

            # Save cache if it wasn't restored AND (on main branch OR manual dispatch)
            - name: Save node_modules cache
              if: steps.node-modules-cache.outputs.cache-hit != 'true' && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
              uses: actions/cache/save@v4
              with:
                  path: |
                      node_modules
                      .yarn/cache
                  key: Linux-node-v1-${{ hashFiles('**/yarn.lock') }}

            - name: Create .env
              run: |
                  # Extract version from tag (remove 'v' prefix), fallback for manual runs
                  VERSION="${GITHUB_REF_NAME#v}"
                  if [ -z "$VERSION" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
                    VERSION="1.0.0-dev"
                  fi
                  cat > .env <<EOF
                  APP_NAME=EtemadLife
                  APP_IDENTIFIER=delivery.etemadlife.platform.drivers
                  APP_LINK_PREFIX=royalstars-el
                  FLEETBASE_HOST=https://api.platform.etemadlife.delivery
                  FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}
                  GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
                  DEFAULT_COORDINATES=36.5399,52.6783
                  FACEBOOK_APP_ID=dummy
                  FACEBOOK_CLIENT_TOKEN=dummy
                  TRANSISTORSOFT_LICENSE_KEY=dummy
                  STOREFRONT_KEY=dummy
                  ANDROID_VERSION_NAME=${VERSION}
                  EOF
                  echo "Created .env with VERSION=${VERSION}"
                  cat .env

            - name: Generate google-services.json (from secret)
              env:
                  GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
              run: |
                  mkdir -p android/app
                  printf '%s' "$GOOGLE_SERVICES_JSON" > android/app/google-services.json

            - name: Validate google-services.json
              run: |
                  python -c "import json,sys; json.load(open('android/app/google-services.json','rb')); print('google-services.json -> valid JSON')"

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'

            # ============================================
            # NINJA - Check if pre-installed before installing
            # ============================================
            - name: Check/Install Ninja
              run: |
                  if command -v ninja &> /dev/null; then
                    echo "✓ Ninja already installed: $(ninja --version)"
                  else
                    sudo apt-get update && sudo apt-get install -y ninja-build
                  fi

            # ============================================
            # ANDROID SDK/NDK/CMAKE - Always ensure installed
            # (Caching system dirs fails due to permission issues)
            # ============================================
            - name: Ensure Android SDK/NDK/CMake toolchain
              shell: bash
              run: |
                  set -e

                  # Find a working sdkmanager (latest if present, else first found)
                  if [ -x "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
                    SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
                  else
                    SDKMGR=$(ls -1d "$ANDROID_SDK_ROOT/cmdline-tools"/*/bin/sdkmanager 2>/dev/null | head -n1 || true)
                    if [ -z "$SDKMGR" ]; then
                      SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/bin/sdkmanager"
                      "$SDKMGR" "cmdline-tools;latest"
                      SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
                    fi
                  fi

                  echo "Using sdkmanager at: $SDKMGR"
                  yes | "$SDKMGR" --licenses >/dev/null 2>&1 || true

                  need() {
                    local p="$1"
                    if ! "$SDKMGR" --list_installed | grep -q "^  $p$"; then
                      echo "Installing $p"
                      "$SDKMGR" "$p"
                    else
                      echo "✓ $p already installed"
                    fi
                  }

                  need "platforms;android-35"
                  need "build-tools;35.0.0"
                  need "ndk;27.1.12297006"
                  need "cmake;3.22.1"

                  "$ANDROID_SDK_ROOT/cmake/3.22.1/bin/cmake" --version || true
                  test -f "$ANDROID_SDK_ROOT/ndk/27.1.12297006/source.properties" && echo "✅ NDK 27.1.12297006 installed"

            # ============================================
            # GRADLE SETUP WITH CACHING
            # cache-overwrite: true prevents creating duplicate entries
            # ============================================
            - name: Setup Gradle
              uses: gradle/actions/setup-gradle@v4
              with:
                  cache-disabled: ${{ env.CLEAN_BUILD == 'true' }}
                  cache-read-only: ${{ github.ref != 'refs/heads/main' && env.CLEAN_BUILD != 'true' }}
                  cache-overwrite-existing: true

            - name: Make Gradlew Executable
              run: cd android && chmod +x ./gradlew

            # ============================================
            # BUILD TAMAGUI - Required before bundling
            # ============================================
            - name: Build Tamagui
              run: yarn tamagui:build

            # ============================================
            # CLEAN JS BUNDLE - Forces Metro to rebuild from source
            # This ensures your TSX/JS changes are ALWAYS included
            # ============================================
            - name: Clean stale JS bundle
              run: |
                  cd android
                  # Delete caching directories
                  rm -rf app/build/generated/assets/
                  rm -rf app/build/intermediates/assets/
                  rm -rf app/build/intermediates/merged_assets/
                  # Delete checked-in bundles (THE ROOT CAUSE)
                  rm -f app/src/main/assets/index.android.bundle
                  rm -f app/src/main/assets/index.android.bundle.meta
                  echo "✓ Cleaned JS bundle directories - will rebuild fresh"

            # ============================================
            # CLEAN GRADLE (only when CLEAN_BUILD is true)
            # ============================================
            - name: Gradle Clean
              if: env.CLEAN_BUILD == 'true'
              run: |
                  cd android
                  ./gradlew clean
                  echo "✓ Gradle clean completed"

            # ============================================
            # BUNDLE JS - Manually bundle to ensure standalone APK
            # This is THE FIX for the "Unable to load script" error
            # ============================================
            - name: Bundle JS (Manual)
              run: |
                  mkdir -p android/app/src/main/assets
                  npx react-native bundle \
                    --platform android \
                    --dev false \
                    --entry-file index.js \
                    --bundle-output android/app/src/main/assets/index.android.bundle \
                    --assets-dest android/app/src/main/res
                  echo "✓ JS bundle created successfully"
                  ls -la android/app/src/main/assets/

            # ============================================
            # BUILD
            # ============================================
            - name: Build Android Debug APK
              run: |
                  cd android
                  ./gradlew assembleDebug --build-cache --console=plain

            - name: Upload Android APK
              uses: actions/upload-artifact@v4
              with:
                  name: android-debug-${{ github.ref_name }}-apk
                  path: android/app/build/outputs/apk/debug/app-debug.apk
                  retention-days: 30

    create_release:
        runs-on: ubuntu-latest
        needs: android_build
        if: startsWith(github.ref, 'refs/tags/')
        steps:
            - uses: actions/checkout@v4
            - name: Publish GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.ref_name }}
                  name: ${{ github.ref_name }}
                  generate_release_notes: true
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
