name: Navigator Android App CI (Windows Runner)

on:
    # Manual trigger only - for testing on local Windows runner
    workflow_dispatch:
        inputs:
            clean_build:
                description: 'Force clean build (no cache)'
                required: false
                type: boolean
                default: false

env:
    FLEETBASE_KEY: ${{ secrets.FLEETBASE_KEY }}
    GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
    TRANSISTORSOFT_LICENSE_KEY: ${{ secrets.TRANSISTORSOFT_LICENSE_KEY }}
    # Windows Android SDK path
    ANDROID_SDK_ROOT: ${{ vars.ANDROID_SDK_ROOT || 'D:\Android\Sdk' }}
    CLEAN_BUILD: ${{ inputs.clean_build }}

jobs:
    android_build:
        runs-on: [self-hosted, Windows, X64]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'

            - name: Enable Corepack
              shell: pwsh
              run: corepack enable

            - name: Activate Yarn 3.6.4
              shell: pwsh
              run: corepack prepare yarn@3.6.4 --activate

            # ============================================
            # LOCAL RUNNER: No GitHub cache needed - use local disk
            # node_modules persists between runs on local runner
            # ============================================
            - name: Install dependencies
              shell: pwsh
              run: |
                  yarn install --immutable

            - name: Create .env
              shell: pwsh
              run: |
                  $VERSION = if ($env:GITHUB_REF_NAME -match '^v(.+)$') { $Matches[1] } else { "1.0.0-local" }
                  $content = @(
                    "APP_NAME=EtemadLife",
                    "APP_IDENTIFIER=delivery.etemadlife.platform.drivers",
                    "APP_LINK_PREFIX=royalstars-el",
                    "FLEETBASE_HOST=https://api.platform.etemadlife.delivery",
                    "FLEETBASE_KEY=${{ secrets.FLEETBASE_KEY }}",
                    "GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}",
                    "DEFAULT_COORDINATES=36.5399,52.6783",
                    "FACEBOOK_APP_ID=dummy",
                    "FACEBOOK_CLIENT_TOKEN=dummy",
                    "TRANSISTORSOFT_LICENSE_KEY=dummy",
                    "STOREFRONT_KEY=dummy",
                    "ANDROID_VERSION_NAME=$VERSION"
                  ) -join "`n"
                  $content | Out-File -FilePath .env -Encoding utf8 -NoNewline
                  Write-Host "Created .env with VERSION=$VERSION"
                  Get-Content .env

            - name: Generate google-services.json (from secret)
              shell: pwsh
              env:
                  GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
              run: |
                  New-Item -ItemType Directory -Force -Path android\app | Out-Null
                  $env:GOOGLE_SERVICES_JSON | Out-File -FilePath android\app\google-services.json -Encoding utf8 -NoNewline

            - name: Validate google-services.json
              shell: pwsh
              run: |
                  $json = Get-Content android\app\google-services.json -Raw | ConvertFrom-Json
                  Write-Host "google-services.json -> valid JSON"

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  distribution: 'temurin'
                  java-version: '17'

            # ============================================
            # CLEAN BUILD - Only if requested
            # ============================================
            - name: Clean build directories
              if: inputs.clean_build == true
              shell: cmd
              run: |
                  cd android
                  gradlew.bat clean --no-watch-fs --info
                  if exist app\build rmdir /s /q app\build
                  if exist .gradle rmdir /s /q .gradle
                  echo Cleaned all build directories

            # ============================================
            # Always clean JS bundle to ensure fresh code
            # ============================================
            - name: Clean stale JS bundle
              shell: pwsh
              run: |
                  Set-Location android
                  # Delete caching directories
                  Remove-Item -Recurse -Force app\build\generated\assets -ErrorAction SilentlyContinue
                  Remove-Item -Recurse -Force app\build\intermediates\assets -ErrorAction SilentlyContinue
                  Remove-Item -Recurse -Force app\build\intermediates\merged_assets -ErrorAction SilentlyContinue
                  # Delete checked-in bundles
                  Remove-Item -Force app\src\main\assets\index.android.bundle -ErrorAction SilentlyContinue
                  Remove-Item -Force app\src\main\assets\index.android.bundle.meta -ErrorAction SilentlyContinue
                  Write-Host "✓ Cleaned JS bundle directories - will rebuild fresh"

            # ============================================
            # BUNDLE JS - Manually bundle to ensure standalone APK
            # ============================================
            - name: Bundle JS (Manual)
              shell: pwsh
              run: |
                  New-Item -ItemType Directory -Force -Path android\app\src\main\assets | Out-Null
                  npx react-native bundle `
                    --platform android `
                    --dev false `
                    --entry-file index.js `
                    --bundle-output android\app\src\main\assets\index.android.bundle `
                    --assets-dest android\app\src\main\res
                  Write-Host "✓ JS bundle created successfully"
                  Get-ChildItem android\app\src\main\assets

            # ============================================
            # BUILD
            # ============================================
            - name: Build Android Debug APK
              shell: cmd
              run: |
                  cd android
                  gradlew.bat assembleDebug --build-cache --console=plain --no-watch-fs --info

            - name: Upload Android APK
              uses: actions/upload-artifact@v4
              with:
                  name: android-debug-windows-${{ github.run_number }}-apk
                  path: android/app/build/outputs/apk/debug/app-debug.apk
                  retention-days: 7

            # ============================================
            # LOCAL RUNNER: Copy APK to local output folder
            # ============================================
            - name: Copy APK to local output
              shell: pwsh
              run: |
                  $outputDir = "$env:USERPROFILE\apk-output"
                  New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
                  $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
                  Copy-Item android\app\build\outputs\apk\debug\app-debug.apk "$outputDir\app-debug-$timestamp.apk"
                  Write-Host "✓ APK copied to $outputDir\"
                  Get-ChildItem $outputDir
